[Unit]
Description=Manually mount /dev/mapper/%I directly
Documentation=https://github.com/Olf0/crypto-sdcard
DefaultDependencies=no
After=systemd-udevd.service systemd-udev-trigger.service cryptosd-luks@%i.service dev-mapper-%i.device systemd-journald.service local-fs.target
Requires=cryptosd-luks@%i.service
# "Requisite=" here would prevent this unit from auto-starting its
# dependencies, when called manually:
PartOf=dev-mapper-%i.device
# Also conflict with umount.target (see man 7 systemd.special), as
# this is a mounting unit, though not a mount unit:
Conflicts=umount.target shutdown.target actdead.target factory-test.target
# Ensure that this Unit is processed before alien-service-manager
# is started (and even more importantly that it is shut down, *after*
# alien-service-manager is shut down), to allow for e.g. (and more),
# android_storage on encrypted SD-card:
Before=alien-service-manager.service umount.target shutdown.target

[Service]
Type=oneshot
RemainAfterExit=yes
#EnvironmentFile=/etc/systemd/system/cryptosd.conf
#EnvironmentFile=-/etc/crypto-sdcard/cryptosd.conf
#EnvironmentFile=-/etc/crypto-sdcard/cryptosd@%I.conf
ExecStartPre=/usr/bin/mkdir -p /media/luks-%I
ExecStart=/bin/mount -v /dev/mapper/%I /media/luks-%I
ExecStop=/bin/umount -vr /dev/mapper/%I
ExecStopPost=/usr/bin/rmdir /media/luks-%I

